<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>File Index Record Utility</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --dpms-color: #e67e22;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      width: 95%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 5px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      padding: 20px 0;
      text-align: center;
      border-radius: 8px 8px 0 0;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .highlight {
      color: var(--dpms-color);
      font-weight: bold;
      text-shadow: 0 0 5px rgba(230, 126, 34, 0.5);
      margin: 0 2px;
    }
    
    .app-description {
      font-size: 1rem;
      opacity: 0.9;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .tabs {
      display: flex;
      background-color: var(--light-color);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .tab-button {
      flex: 1;
      padding: 15px;
      text-align: center;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tab-button.active {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .tab-button:hover:not(.active) {
      background-color: #d6dbdf;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      flex: 1;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: flex;
      flex-direction: column;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 0.9rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 7px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 0.95rem;
      transition: border 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    button {
      padding: 12px 20px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    
    button:hover {
      background-color: #2980b9;
    }
    
    .btn-danger {
      background-color: var(--accent-color);
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #27ae60;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e67e22;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .table-container {
      overflow-x: auto;
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #e8f4fc;
    }
    
    .actions-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-icon {
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    
    .edit-icon {
      color: var(--secondary-color);
    }
    
    .edit-icon:hover {
      background-color: rgba(52, 152, 219, 0.1);
    }
    
    .delete-icon {
      color: var(--accent-color);
    }
    
    .delete-icon:hover {
      background-color: rgba(231, 76, 60, 0.1);
    }
    
    .file-icon {
      color: var(--success-color);
    }
    
    .file-icon:hover {
      background-color: rgba(46, 204, 113, 0.1);
    }
    
    .search-sort-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .search-box {
      flex: 1;
      min-width: 300px;
      position: relative;
    }
    
    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #7f8c8d;
    }
    
    .search-box input {
      padding-left: 40px;
    }
    
    .sort-options {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .utility-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .print-options {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 6px;
      color: white;
      background-color: var(--success-color);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background-color: var(--accent-color);
    }
    
    /* Form layout adjustments */
    .form-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 0;
    }

    /* First row: 20% File Number, 20% Volume, 57% Subject */
    .form-row.row-1 .form-group:nth-child(1) {
      flex: 0 0 20%;
    }
    .form-row.row-1 .form-group:nth-child(2) {
      flex: 0 0 20%;
    }
    .form-row.row-1 .form-group:nth-child(3) {
      flex: 0 0 57%;
    }

    /* Second row: 25% for each of the four fields */
    .form-row.row-2 .form-group {
      flex: 0 0 calc(25% - 15px);
    }

    /* Button row */
    .button-row {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      align-items: center;
    }

    /* Validation styles */
    .error {
      color: #d32f2f;
      font-size: 0.85rem;
      margin-top: -12px;
      margin-bottom: 12px;
      display: none;
    }
    
    input.invalid, textarea.invalid {
      border-color: #d32f2f;
      background-color: #ffebee;
    }

    /* Pagination styles */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 8px;
    }
    
    .pagination button {
      padding: 6px 12px;
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .pagination button.active {
      background: #2980b9;
      font-weight: bold;
    }
    
    .pagination button:hover:not(.active) {
      background: #3498db;
    }
    
    .pagination button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    /* Print styles - Enhanced for better printing */
    .print-section {
      display: none;
    }
    
    @media print {
      body, html {
        height: auto;
        width: auto;
        background: white;
        color: black;
        overflow: visible;
        font-family: Arial, sans-serif;
        font-size: 12pt;
        margin: 0;
        padding: 0;
      }
      
      .container, .print-section {
        width: 100%;
        margin: 0;
        padding: 0;
        box-shadow: none;
        border-radius: 0;
      }
      
      header, .tabs, #msg, button, input[type=file], 
      .download-upload, .tab-content:not(.report-tab), 
      .print-options, .notification, .pagination,
      .search-sort-container, .utility-buttons {
        display: none !important;
      }
      
      .print-section {
        display: block !important;
        page-break-inside: avoid;
      }
      
      .print-report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10pt;
        margin-top: 10px;
        table-layout: fixed;
      }
      
      .print-report-table th,
      .print-report-table td {
        border: 1px solid #000;
        padding: 6px 8px;
        text-align: left;
        word-wrap: break-word;
        page-break-inside: avoid;
      }
      
      .print-report-table th {
        background-color: #f0f0f0 !important;
        color: #000 !important;
        font-weight: bold;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .print-report-table tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      .print-report-table td {
        page-break-inside: avoid;
      }
      
      .print-header {
        text-align: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
      }
      
      .print-header h2 {
        font-size: 16pt;
        margin-bottom: 5px;
      }
      
      .print-header p {
        font-size: 11pt;
        margin: 3px 0;
      }
      
      .print-footer {
        margin-top: 20px;
        text-align: right;
        font-size: 10pt;
        border-top: 1px solid #000;
        padding-top: 10px;
      }
      
      @page {
        size: landscape;
        margin: 15mm;
      }
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      .form-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .form-row .form-group {
        flex: 0 0 100% !important;
      }
      
      .button-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .pagination {
        flex-wrap: wrap;
      }
      
      .utility-buttons {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
    
    @media (max-width: 768px) {
      h1 {
        font-size: 2rem;
        flex-direction: column;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .search-sort-container {
        flex-direction: column;
      }
      
      .search-box {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        <span class="highlight">D</span>igital 
        <span class="highlight">F</span>ile 
        <span class="highlight">I</span>ndex 
        <span class="highlight">U</span>tility
      </h1>
      <p class="app-description">Manage file records with this comprehensive tool. Add, search, and generate reports with ease.</p>
    </header>
    
    <div class="tabs">
      <button class="tab-button active" data-tab="entry">Data Entry</button>
      <button class="tab-button" data-tab="search">Search Files</button>
      <button class="tab-button" data-tab="report">View/Print Reports</button>
    </div>

    <div id="entry" class="tab-content active">
      <h2>Add New File Record</h2>
      <form id="fileForm">
        <div class="form-container">
          <!-- First row: File Number, Volume Number, Subject -->
          <div class="form-row row-1">
            <div class="form-group">
              <label for="fileNumber">File Number *</label>
              <input type="text" id="fileNumber" required />
              <div id="fileNumberError" class="error"></div>
            </div>
            <div class="form-group">
              <label for="volumeNumber">Volume Number *</label>
              <input type="text" id="volumeNumber" required />
              <div id="volumeNumberError" class="error"></div>
            </div>
            <div class="form-group">
              <label for="subject">Subject *</label>
              <textarea id="subject" rows="1" required></textarea>
              <div id="subjectError" class="error"></div>
            </div>
          </div>
          
          <!-- Second row: Dates and Location -->
          <div class="form-row row-2">
            <div class="form-group">
              <label for="dateOpened">Date Opened *</label>
              <input type="date" id="dateOpened" required />
              <div id="dateOpenedError" class="error"></div>
            </div>
            <div class="form-group">
              <label for="dateClosed">Date Closed</label>
              <input type="date" id="dateClosed" />
              <div id="dateClosedError" class="error"></div>
            </div>
            <div class="form-group">
              <label for="dateDestruction">Date of Destruction</label>
              <input type="date" id="dateDestruction" />
              <div id="dateDestructionError" class="error"></div>
            </div>
            <div class="form-group">
              <label for="storedLocation">Stored Location *</label>
              <input type="text" id="storedLocation" required />
              <div id="storedLocationError" class="error"></div>
            </div>
          </div>
          
          <!-- Button row -->
          <div class="button-row">
            <button type="submit" class="btn-success">
              <i class="fas fa-save"></i> Save Record
            </button>
            <button type="button" id="resetBtn" class="btn-warning">
              <i class="fas fa-undo"></i> Reset Form
            </button>
            <div class="download-upload utility-buttons">
              <button type="button" id="downloadBtn" class="btn-success">
                <i class="fas fa-download"></i> Download Records (.json)
              </button>
              <input type="file" accept=".json" id="jsonUpload" style="display:none;"/>
              <button type="button" id="uploadBtn" class="btn-warning">
                <i class="fas fa-upload"></i> Load Records (.json)
              </button>
            </div>
          </div>
          
          <div id="msg" class="notification"></div>
        </div>
      </form>
    </div>

    <div id="search" class="tab-content">
      <h2>Search Files</h2>
      
      <div class="search-sort-container">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search by file number, subject, or location..." />
        </div>
      </div>
      
      <div class="table-container">
        <div id="searchResults" style="overflow-y:auto; flex-grow:1;"></div>
      </div>
      
      <div id="pagination" class="pagination"></div>
    </div>

    <div id="report" class="tab-content report-tab">
      <h2>Print File Index</h2>
      
      <div class="print-options">
        <button id="printCurrentBtn" class="btn-success">
          <i class="fas fa-print"></i> Print Current Files
        </button>
        <button id="printClosedBtn" class="btn-success">
          <i class="fas fa-print"></i> Print Closed Files
        </button>
        <button id="printDestroyedBtn" class="btn-success">
          <i class="fas fa-print"></i> Print Destroyed Files
        </button>
      </div>
      
      <!-- Print section that will be shown only during printing -->
      <div id="printSection" class="print-section">
        <div class="print-header">
          <h2 id="printTitle">File Index Report</h2>
          <p id="printSubtitle"></p>
          <p>Generated on: <span id="printDate"></span></p>
        </div>
        <div id="printTable"></div>
        <div class="print-footer">
          <p>Total Records: <span id="printTotal"></span></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize records array
    let records = JSON.parse(localStorage.getItem('fileRecords')) || [];
    let editRecordId = null;
    
    // Pagination variables
    let currentPage = 1;
    const recordsPerPage = 10;
    
    // DOM Elements
    const msgEl = document.getElementById('msg');
    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const fileForm = document.getElementById('fileForm');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const printTable = document.getElementById('printTable');
    const printTitle = document.getElementById('printTitle');
    const printSubtitle = document.getElementById('printSubtitle');
    const printDate = document.getElementById('printDate');
    const printTotal = document.getElementById('printTotal');
    const paginationEl = document.getElementById('pagination');
    
    // Button references
    const downloadBtn = document.getElementById('downloadBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const jsonUpload = document.getElementById('jsonUpload');
    const printCurrentBtn = document.getElementById('printCurrentBtn');
    const printClosedBtn = document.getElementById('printClosedBtn');
    const printDestroyedBtn = document.getElementById('printDestroyedBtn');
    const resetBtn = document.getElementById('resetBtn');

    // Format date to DD-MM-YYYY
    function formatDateDMY(dateStr) {
      if (!dateStr) return '-';
      const [y, m, d] = dateStr.split('-');
      return `${d}-${m}-${y}`;
    }

    // Validate date sequence
    function validateDateSequence(dateOpened, dateClosed, dateDestruction) {
      if (dateClosed && dateOpened > dateClosed) {
        return "Date Closed cannot be before Date Opened";
      }
      
      if (dateDestruction) {
        if (dateOpened > dateDestruction) {
          return "Date of Destruction cannot be before Date Opened";
        }
        if (dateClosed && dateClosed > dateDestruction) {
          return "Date of Destruction cannot be before Date Closed";
        }
      }
      
      return null;
    }

    // Validate file number format (more permissive for international characters)
    function validateFileNumber(fileNumber) {
      // More permissive validation - allows most characters except those that could cause issues
      const invalidChars = /[<>:"\\|?*]/;
      if (invalidChars.test(fileNumber)) {
        return "File Number cannot contain <, >, :, \", \\, |, ?, or *";
      }
      return null;
    }

    // Check for duplicate file number AND volume number combination
    function isDuplicateFileVolume(fileNumber, volumeNumber, currentId = null) {
      return records.some(record => 
        record.fileNumber === fileNumber && 
        record.volumeNumber === volumeNumber && 
        record.id !== currentId
      );
    }

    // Show validation error
    function showError(fieldId, message) {
      const errorEl = document.getElementById(fieldId + 'Error');
      const inputEl = document.getElementById(fieldId);
      
      if (errorEl && inputEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        inputEl.classList.add('invalid');
      }
    }

    // Clear validation error
    function clearError(fieldId) {
      const errorEl = document.getElementById(fieldId + 'Error');
      const inputEl = document.getElementById(fieldId);
      
      if (errorEl && inputEl) {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
        inputEl.classList.remove('invalid');
      }
    }

    // Clear all validation errors
    function clearAllErrors() {
      const errorFields = [
        'fileNumber', 'volumeNumber', 'subject', 
        'dateOpened', 'dateClosed', 'dateDestruction', 'storedLocation'
      ];
      
      errorFields.forEach(field => clearError(field));
    }

    // Tab switching functionality
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        // Update tabs
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update content
        tabContents.forEach(content => content.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        // If switching to report tab, render the report
        if (tabId === 'report') {
          renderReport();
        } else if (tabId === 'search') {
          // If switching to search tab, perform initial search
          performSearch();
        }
      });
    });

    // Form submission
    fileForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Clear previous errors
      clearAllErrors();
      
      // Get form values
      const fileNumber = document.getElementById('fileNumber').value.trim();
      const volumeNumber = document.getElementById('volumeNumber').value.trim();
      const subject = document.getElementById('subject').value.trim();
      const dateOpened = document.getElementById('dateOpened').value;
      const dateClosed = document.getElementById('dateClosed').value;
      const dateDestruction = document.getElementById('dateDestruction').value;
      const storedLocation = document.getElementById('storedLocation').value.trim();
      
      // Validate required fields
      let isValid = true;
      
      if (!fileNumber) {
        showError('fileNumber', 'File Number is required');
        isValid = false;
      } else {
        const fileNumberError = validateFileNumber(fileNumber);
        if (fileNumberError) {
          showError('fileNumber', fileNumberError);
          isValid = false;
        }
      }
      
      if (!volumeNumber) {
        showError('volumeNumber', 'Volume Number is required');
        isValid = false;
      }
      
      if (!subject) {
        showError('subject', 'Subject is required');
        isValid = false;
      }
      
      if (!dateOpened) {
        showError('dateOpened', 'Date Opened is required');
        isValid = false;
      }
      
      if (!storedLocation) {
        showError('storedLocation', 'Stored Location is required');
        isValid = false;
      }
      
      // Check for duplicate file number and volume number
      if (isDuplicateFileVolume(fileNumber, volumeNumber, editRecordId)) {
        showError('fileNumber', 'A file with this number and volume already exists');
        isValid = false;
      }
      
      // Validate date sequence
      const dateError = validateDateSequence(dateOpened, dateClosed, dateDestruction);
      if (dateError) {
        showError('dateOpened', dateError);
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Create record object
      const record = {
        id: editRecordId || Date.now().toString(),
        fileNumber,
        volumeNumber,
        subject,
        dateOpened,
        dateClosed,
        dateDestruction,
        storedLocation
      };
      
      // Add or update record
      if (editRecordId) {
        // Update existing record
        const index = records.findIndex(r => r.id === editRecordId);
        if (index !== -1) {
          records[index] = record;
          showNotification('Record updated successfully!');
        }
      } else {
        // Add new record
        records.push(record);
        showNotification('Record saved successfully!');
      }
      
      // Save to localStorage
      localStorage.setItem('fileRecords', JSON.stringify(records));
      
      // Reset form
      resetForm();
    });

    // Reset form
    function resetForm() {
      fileForm.reset();
      editRecordId = null;
      clearAllErrors();
      document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Save Record';
    }

    // Reset button handler
    resetBtn.addEventListener('click', resetForm);

    // Search functionality
    searchInput.addEventListener('input', performSearch);
    
    function performSearch() {
      const searchTerm = searchInput.value.toLowerCase();
      currentPage = 1; // Reset to first page on new search
      
      if (!searchTerm) {
        renderAllRecords();
        return;
      }
      
      const filteredRecords = records.filter(record => 
        record.fileNumber.toLowerCase().includes(searchTerm) ||
        record.subject.toLowerCase().includes(searchTerm) ||
        record.storedLocation.toLowerCase().includes(searchTerm)
      );
      
      renderSearchResults(filteredRecords);
    }
    
    function renderAllRecords() {
      renderSearchResults(records);
    }
    
    function renderSearchResults(results) {
      if (results.length === 0) {
        searchResults.innerHTML = '<p>No records found.</p>';
        paginationEl.innerHTML = '';
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(results.length / recordsPerPage);
      const startIndex = (currentPage - 1) * recordsPerPage;
      const paginatedResults = results.slice(startIndex, startIndex + recordsPerPage);
      
      // Create table
      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>File No.</th>
              <th>Volume</th>
              <th>Subject</th>
              <th>Date Opened</th>
              <th>Date Closed</th>
              <th>Date of Destruction</th>
              <th>Location</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      paginatedResults.forEach(record => {
        tableHTML += `
          <tr>
            <td>${record.fileNumber}</td>
            <td>${record.volumeNumber}</td>
            <td>${record.subject}</td>
            <td>${formatDateDMY(record.dateOpened)}</td>
            <td>${record.dateClosed ? formatDateDMY(record.dateClosed) : '-'}</td>
            <td>${record.dateDestruction ? formatDateDMY(record.dateDestruction) : '-'}</td>
            <td>${record.storedLocation}</td>
            <td class="actions-cell">
              <i class="fas fa-edit action-icon edit-icon" data-id="${record.id}" title="Edit"></i>
              <i class="fas fa-trash action-icon delete-icon" data-id="${record.id}" title="Delete"></i>
            </td>
          </tr>
        `;
      });
      
      tableHTML += '</tbody></table>';
      searchResults.innerHTML = tableHTML;
      
      // Add event listeners to the buttons
      document.querySelectorAll('.edit-icon').forEach(icon => {
        icon.addEventListener('click', function() {
          editRecord(this.getAttribute('data-id'));
        });
      });
      
      document.querySelectorAll('.delete-icon').forEach(icon => {
        icon.addEventListener('click', function() {
          deleteRecord(this.getAttribute('data-id'));
        });
      });
      
      // Render pagination
      renderPagination(results.length);
    }
    
    function renderPagination(totalRecords) {
      const totalPages = Math.ceil(totalRecords / recordsPerPage);
      
      if (totalPages <= 1) {
        paginationEl.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // Previous button
      paginationHTML += `<button class="pagination-btn" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
      
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
      }
      
      // Next button
      paginationHTML += `<button class="pagination-btn" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
      
      paginationEl.innerHTML = paginationHTML;
      
      // Add event listeners to pagination buttons
      document.querySelectorAll('.pagination-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          if (!this.disabled) {
            changePage(parseInt(this.getAttribute('data-page')));
          }
        });
      });
    }
    
    // Change page function
    function changePage(page) {
      const totalPages = Math.ceil(records.length / recordsPerPage);
      
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      performSearch();
    }
    
    // Edit record function
    function editRecord(id) {
      const record = records.find(r => r.id === id);
      
      if (!record) return;
      
      // Populate form
      document.getElementById('fileNumber').value = record.fileNumber;
      document.getElementById('volumeNumber').value = record.volumeNumber;
      document.getElementById('subject').value = record.subject;
      document.getElementById('dateOpened').value = record.dateOpened;
      document.getElementById('dateClosed').value = record.dateClosed || '';
      document.getElementById('dateDestruction').value = record.dateDestruction || '';
      document.getElementById('storedLocation').value = record.storedLocation;
      
      // Set edit mode
      editRecordId = id;
      document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-edit"></i> Update Record';
      
      // Switch to entry tab
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector('.tab-button[data-tab="entry"]').classList.add('active');
      
      tabContents.forEach(content => content.classList.remove('active'));
      document.getElementById('entry').classList.add('active');
    }
    
    // Delete record function
    function deleteRecord(id) {
      if (!confirm('Are you sure you want to delete this record?')) return;
      
      records = records.filter(record => record.id !== id);
      localStorage.setItem('fileRecords', JSON.stringify(records));
      
      // Refresh search results
      performSearch();
      
      // Show confirmation message
      showNotification('Record deleted successfully!');
    }
    
    // Report generation
    function renderReport() {
      // This function can be used to prepare the report view if needed
    }
    
    // Print functionality - Enhanced with serial numbers
    printCurrentBtn.addEventListener('click', () => {
      const currentFiles = records.filter(r => !r.dateClosed && !r.dateDestruction);
      generatePrintableTable(currentFiles, 'Current Files Report', 'All files that are currently active');
    });
    
    printClosedBtn.addEventListener('click', () => {
      const closedFiles = records.filter(r => r.dateClosed && !r.dateDestruction);
      generatePrintableTable(closedFiles, 'Closed Files Report', 'All files that have been closed');
    });
    
    printDestroyedBtn.addEventListener('click', () => {
      const destroyedFiles = records.filter(r => r.dateDestruction);
      generatePrintableTable(destroyedFiles, 'Destroyed Files Report', 'All files that have been destroyed');
    });
    
    function generatePrintableTable(data, title, subtitle) {
      // Set print content
      printTitle.textContent = title;
      printSubtitle.textContent = subtitle;
      printDate.textContent = new Date().toLocaleDateString();
      printTotal.textContent = data.length;
      
      // Generate table with serial numbers
      let tableHTML = `
        <table class="print-report-table">
          <thead>
            <tr>
              <th width="5%">S.No</th>
              <th width="12%">File No.</th>
              <th width="8%">Volume</th>
              <th width="25%">Subject</th>
              <th width="10%">Date Opened</th>
              <th width="10%">Date Closed</th>
              <th width="12%">Date of Destruction</th>
              <th width="18%">Location</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      if (data.length === 0) {
        tableHTML += `
          <tr>
            <td colspan="8" style="text-align: center;">No records found</td>
          </tr>
        `;
      } else {
        data.forEach((record, index) => {
          tableHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${record.fileNumber}</td>
              <td>${record.volumeNumber}</td>
              <td>${record.subject}</td>
              <td>${formatDateDMY(record.dateOpened)}</td>
              <td>${record.dateClosed ? formatDateDMY(record.dateClosed) : '-'}</td>
              <td>${record.dateDestruction ? formatDateDMY(record.dateDestruction) : '-'}</td>
              <td>${record.storedLocation}</td>
            </tr>
          `;
        });
      }
      
      tableHTML += '</tbody></table>';
      printTable.innerHTML = tableHTML;
      
      // Trigger print
      window.print();
    }
    
    // Download records
    downloadBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(records, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = 'file_records.json';
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    });
    
    // Upload records
    uploadBtn.addEventListener('click', () => {
      jsonUpload.click();
    });
    
    jsonUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const uploadedRecords = JSON.parse(e.target.result);
          
          if (Array.isArray(uploadedRecords)) {
            // Validate each record has required fields
            const isValid = uploadedRecords.every(record => 
              record.fileNumber && record.volumeNumber && record.subject && 
              record.dateOpened && record.storedLocation
            );
            
            if (isValid) {
              records = uploadedRecords;
              localStorage.setItem('fileRecords', JSON.stringify(records));
              showNotification('Records loaded successfully!');
              performSearch();
            } else {
              showNotification('Invalid file format. Some records are missing required fields.', 'error');
            }
          } else {
            showNotification('Invalid file format. Expected an array of records.', 'error');
          }
        } catch (error) {
          showNotification('Error parsing JSON file. Please check the file format.', 'error');
        }
      };
      
      reader.readAsText(file);
      // Reset the file input
      event.target.value = '';
    });
    
    // Show notification
    function showNotification(message, type = 'success') {
      msgEl.textContent = message;
      msgEl.className = 'notification show';
      if (type === 'error') {
        msgEl.classList.add('error');
      }
      
      setTimeout(() => {
        msgEl.classList.remove('show');
      }, 3000);
    }
    
    // Initialize the app
    function init() {
      // Render initial search results
      performSearch();
    }
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
